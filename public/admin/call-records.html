<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin • Call Records</title>
	<link rel="stylesheet" href="../assets/frappe.css" />
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		.chart-title{margin:0 0 12px;font-weight:600;font-size:16px}
		.grid.charts{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
		.card .chart-box{height:300px}
		@media (max-width: 768px){ .grid.charts{grid-template-columns:1fr} }
		
		/* Call Records specific styles */
		.call-status-badge {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			min-width: 70px;
			text-align: center;
		}
		
		.call-status-completed { background: rgba(16, 185, 129, 0.1); color: #10b981; }
		.call-status-missed { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
		.call-status-declined { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
		.call-status-not_lifted { background: rgba(100, 116, 139, 0.1); color: #64748b; }
		.call-status-wrong_number { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
		.call-status-busy { background: rgba(6, 182, 212, 0.1); color: #06b6d4; }
		.call-status-unreachable { background: rgba(251, 113, 133, 0.1); color: #fb7185; }
		.call-status-voicemail { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
		
		.quality-indicator {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			font-size: 12px;
		}
		
		.quality-indicator .dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
		}
		
		.quality-excellent .dot { background: #10b981; }
		.quality-good .dot { background: #3b82f6; }
		.quality-fair .dot { background: #f59e0b; }
		.quality-poor .dot { background: #ef4444; }
		
		.call-duration {
			font-family: monospace;
			font-weight: 600;
			color: var(--text-primary);
		}
		
		.employee-info {
			display: flex;
			align-items: center;
			gap: 8px;
		}
		
		.employee-avatar {
			width: 24px;
			height: 24px;
			border-radius: 50%;
			background: var(--primary);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 10px;
			font-weight: 600;
		}
	</style>
</head>
<body>
	<div class="admin-shell">
		<aside class="admin-sidebar">
			<div class="brand"><h1>TeleCRM Admin</h1></div>
			<nav>
				<a href="/admin/overview.html">Overview</a>
				<a href="/admin/users.html">Users</a>
				<a href="/admin/leads.html">Leads</a>
				<a href="/admin/campaigns.html">Campaigns</a>
				<a href="/admin/pipelines.html">Pipelines</a>
				<a href="/admin/sims.html">SIMs</a>
				<a href="/admin/call-records.html" class="active">Call Records</a>
				<a href="/admin/analytics.html">Analytics</a>
				<a href="/admin/user-performance.html">User Performance</a>
				<a href="/admin/settings.html">Settings</a>
			</nav>
		</aside>
		<main class="admin-main">
			<div class="admin-topbar">
				<h2 class="page-title">Call Records</h2>
				<div class="toolbar">
					<button class="btn" id="refresh">Refresh</button>
					<select class="input" id="statusFilter" style="min-width:140px">
						<option value="">All Status</option>
						<option value="completed">Completed</option>
						<option value="missed">Missed</option>
						<option value="declined">Declined</option>
						<option value="not_lifted">Not Lifted</option>
						<option value="wrong_number">Wrong Number</option>
						<option value="busy">Busy</option>
						<option value="unreachable">Unreachable</option>
						<option value="voicemail">Voicemail</option>
					</select>
					<select class="input" id="employeeFilter" style="min-width:160px">
						<option value="">All Employees</option>
					</select>
					<input class="input" id="searchFilter" placeholder="Search calls..." style="min-width:200px" />
				</div>
			</div>
			
			<!-- Call Records Summary -->
			<div class="grid cols-4" id="callSummary" style="margin-bottom:16px">
				<div class="card"><div>Total Calls</div><h3 id="mTotalCalls">-</h3></div>
				<div class="card"><div>Completed Calls</div><h3 id="mCompletedCalls">-</h3></div>
				<div class="card"><div>Success Rate</div><h3 id="mSuccessRate">-</h3></div>
				<div class="card"><div>Avg Duration</div><h3 id="mAvgDuration">-</h3></div>
			</div>
			
			<!-- Call Records Table -->
			<div class="card">
				<div class="table-header">
					<h3 class="table-title">
						<i class="fas fa-phone"></i>
						Call Records
					</h3>
					<div class="table-actions">
						<span class="selected-count" id="totalRecords">0 records</span>
					</div>
				</div>
				<div class="table-wrapper">
					<table class="data-table">
						<thead>
							<tr>
								<th>Employee</th>
								<th>Lead</th>
								<th>Status</th>
								<th>Duration</th>
								<th>Quality</th>
								<th>SIM</th>
								<th>Date</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody id="callRecordsTable">
							<!-- Call records will be loaded here -->
						</tbody>
					</table>
				</div>
			</div>
			
			<!-- Call Analytics Charts -->
			<div class="grid cols-2 charts" style="margin-top:24px">
				<div class="card">
					<h3 class="chart-title">Call Status Distribution</h3>
					<div class="chart-box"><canvas id="callStatusChart"></canvas></div>
				</div>
				<div class="card">
					<h3 class="chart-title">Calls by Employee</h3>
					<div class="chart-box"><canvas id="callsByEmployeeChart"></canvas></div>
				</div>
				<div class="card">
					<h3 class="chart-title">Calls by Hour</h3>
					<div class="chart-box"><canvas id="callsByHourChart"></canvas></div>
				</div>
				<div class="card">
					<h3 class="chart-title">Calls by Day</h3>
					<div class="chart-box"><canvas id="callsByDayChart"></canvas></div>
				</div>
			</div>
		</main>
	</div>
	
	<script src="../assets/admin.js"></script>
	<script>
		Admin.navActivate('/admin/call-records.html');
		let callRecords = [];
		let charts = {};
		
		function formatDuration(seconds) {
			if (!seconds) return '0s';
			const mins = Math.floor(seconds / 60);
			const secs = seconds % 60;
			return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
		}
		
		function getCallStatusBadge(status) {
			const statusMap = {
				'completed': 'Completed',
				'missed': 'Missed',
				'declined': 'Declined',
				'not_lifted': 'Not Lifted',
				'wrong_number': 'Wrong Number',
				'busy': 'Busy',
				'unreachable': 'Unreachable',
				'voicemail': 'Voicemail'
			};
			return `<span class="call-status-badge call-status-${status}">${statusMap[status] || status}</span>`;
		}
		
		function getQualityIndicator(quality) {
			if (!quality) return '-';
			const qualityMap = {
				'Excellent': 'excellent',
				'Good': 'good',
				'Fair': 'fair',
				'Poor': 'poor'
			};
			const cls = qualityMap[quality] || 'good';
			return `<span class="quality-indicator quality-${cls}"><span class="dot"></span>${quality}</span>`;
		}
		
		function renderCallRecordsTable(records) {
			const tbody = document.getElementById('callRecordsTable');
			
			if (records.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="8" class="empty-state">
							<i class="fas fa-phone-slash"></i>
							<h4>No call records found</h4>
							<p>Call records will appear here once employees start logging calls.</p>
						</td>
					</tr>
				`;
				return;
			}
			
			tbody.innerHTML = records.map(record => `
				<tr>
					<td>
						<div class="employee-info">
							<div class="employee-avatar">${(record.employee?.name || 'U').charAt(0).toUpperCase()}</div>
							<div>
								<strong>${record.employee?.name || 'Unknown'}</strong><br>
								<small>${record.employee?.email || 'No email'}</small>
							</div>
						</div>
					</td>
					<td>
						<strong>${record.lead?.name || 'Unknown Lead'}</strong><br>
						<small>${record.lead?.phone || 'No phone'} • ${record.lead?.sector || 'Unknown'}</small>
					</td>
					<td>${getCallStatusBadge(record.callStatus)}</td>
					<td><span class="call-duration">${formatDuration(record.callDuration)}</span></td>
					<td>
						<div>Signal: ${getQualityIndicator(record.callQuality?.signalStrength)}</div>
						<div>Audio: ${getQualityIndicator(record.callQuality?.audioQuality)}</div>
					</td>
					<td>
						<small>${record.simCard?.simNumber || 'No SIM'}<br>
						${record.simCard?.carrier || 'Unknown'}</small>
					</td>
					<td>${Admin.fmtDate(record.createdAt)}</td>
					<td>
						<button class="btn btn-outline" onclick="viewCallDetails('${record._id}')" title="View Details">
							<i class="fas fa-eye"></i>
						</button>
					</td>
				</tr>
			`).join('');
		}
		
		function renderCharts(analytics) {
			// Call Status Distribution
			const statusData = Object.entries(analytics.statusDistribution || {});
			if (statusData.length > 0) {
				renderChart('callStatusChart', 'doughnut', 
					statusData.map(([status, count]) => status.charAt(0).toUpperCase() + status.slice(1)), 
					statusData.map(([status, count]) => count)
				);
			}
			
			// Calls by Employee
			const employeeData = Object.entries(analytics.callsByEmployee || {});
			if (employeeData.length > 0) {
				renderChart('callsByEmployeeChart', 'bar', 
					employeeData.map(([name, data]) => name), 
					employeeData.map(([name, data]) => data.totalCalls)
				);
			}
			
			// Calls by Hour
			const hourData = Object.entries(analytics.callsByHour || {});
			if (hourData.length > 0) {
				renderChart('callsByHourChart', 'line', 
					hourData.map(([hour, count]) => `${hour}:00`), 
					hourData.map(([hour, count]) => count)
				);
			}
			
			// Calls by Day
			const dayData = Object.entries(analytics.callsByDay || {});
			if (dayData.length > 0) {
				renderChart('callsByDayChart', 'bar', 
					dayData.map(([day, count]) => day), 
					dayData.map(([day, count]) => count)
				);
			}
		}
		
		function renderChart(id, type, labels, data) {
			const el = document.getElementById(id);
			if (!el) return;
			
			const ctx = el.getContext('2d');
			if (charts[id]) charts[id].destroy();
			
			const colors = type === 'line' ? '#5E64FF' : 
				['#5E64FF', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#14b8a6', '#64748b'];
			
			const ds = type === 'line' ? 
				{ label: id, data, borderColor: colors, backgroundColor: 'rgba(94,100,255,.12)', tension: .4, fill: true } :
				{ label: id, data, backgroundColor: colors.slice(0, labels.length), borderRadius: 8 };
			
			charts[id] = new Chart(ctx, {
				type,
				data: { labels, datasets: [ds] },
				options: { 
					plugins: { legend: { display: false } }, 
					responsive: true, 
					maintainAspectRatio: false 
				}
			});
		}
		
		function applyFilters() {
			const statusFilter = document.getElementById('statusFilter').value;
			const employeeFilter = document.getElementById('employeeFilter').value;
			const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
			
			let filtered = callRecords;
			
			if (statusFilter) {
				filtered = filtered.filter(record => record.callStatus === statusFilter);
			}
			
			if (employeeFilter) {
				filtered = filtered.filter(record => record.employee?._id === employeeFilter);
			}
			
			if (searchFilter) {
				filtered = filtered.filter(record => 
					record.lead?.name?.toLowerCase().includes(searchFilter) ||
					record.lead?.phone?.includes(searchFilter) ||
					record.employee?.name?.toLowerCase().includes(searchFilter)
				);
			}
			
			renderCallRecordsTable(filtered);
			document.getElementById('totalRecords').textContent = `${filtered.length} records`;
		}
		
		async function loadCallRecords() {
			try {
				const [recordsRes, analyticsRes] = await Promise.all([
					fetch('/api/admin/call-records', { headers: Admin.authHeaders() }),
					fetch('/api/admin/call-records/analytics', { headers: Admin.authHeaders() })
				]);
				
				if (recordsRes.ok) {
					callRecords = await recordsRes.json();
					renderCallRecordsTable(callRecords);
					document.getElementById('totalRecords').textContent = `${callRecords.length} records`;
					
					// Populate employee filter
					const employees = [...new Set(callRecords.map(r => r.employee?._id).filter(Boolean))];
					const employeeSelect = document.getElementById('employeeFilter');
					employeeSelect.innerHTML = '<option value="">All Employees</option>' + 
						employees.map(id => {
							const emp = callRecords.find(r => r.employee?._id === id)?.employee;
							return `<option value="${id}">${emp?.name || 'Unknown'}</option>`;
						}).join('');
				}
				
				if (analyticsRes.ok) {
					const analytics = await analyticsRes.json();
					
					// Update summary metrics
					document.getElementById('mTotalCalls').textContent = analytics.totalCalls || 0;
					document.getElementById('mCompletedCalls').textContent = analytics.statusDistribution?.completed || 0;
					document.getElementById('mSuccessRate').textContent = 
						analytics.totalCalls > 0 ? 
						Math.round((analytics.statusDistribution?.completed || 0) / analytics.totalCalls * 100) + '%' : '0%';
					document.getElementById('mAvgDuration').textContent = formatDuration(analytics.avgCallDuration || 0);
					
					// Render charts
					renderCharts(analytics);
				}
			} catch (error) {
				console.error('Failed to load call records:', error);
			}
		}
		
		function viewCallDetails(recordId) {
			const record = callRecords.find(r => r._id === recordId);
			if (!record) return;
			
			alert(`Call Details:\n\nEmployee: ${record.employee?.name || 'Unknown'}\nLead: ${record.lead?.name || 'Unknown'}\nStatus: ${record.callStatus}\nDuration: ${formatDuration(record.callDuration)}\nNotes: ${record.notes || 'No notes'}`);
		}
		
		// Event listeners
		document.getElementById('refresh').addEventListener('click', loadCallRecords);
		document.getElementById('statusFilter').addEventListener('change', applyFilters);
		document.getElementById('employeeFilter').addEventListener('change', applyFilters);
		document.getElementById('searchFilter').addEventListener('input', () => {
			setTimeout(applyFilters, 300);
		});
		
		// Load data on page load
		if (Admin.getToken()) {
			loadCallRecords();
		}
	</script>
</body>
</html>
