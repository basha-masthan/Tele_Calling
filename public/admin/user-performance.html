<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin â€¢ User Performance</title>
	<link rel="stylesheet" href="../assets/frappe.css" />
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		.performance-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		.performance-card {
			background: var(--bg-card);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			padding: 20px;
			box-shadow: var(--shadow-sm);
		}
		.performance-card h3 {
			margin: 0 0 15px 0;
			color: var(--text-primary);
			font-size: 18px;
		}
		.stat-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 8px 0;
			border-bottom: 1px solid var(--border);
		}
		.stat-row:last-child {
			border-bottom: none;
		}
		.stat-label {
			color: var(--text-secondary);
			font-size: 14px;
		}
		.stat-value {
			font-weight: 600;
			color: var(--text-primary);
		}
		.stat-value.completed { color: var(--success); }
		.stat-value.pending { color: var(--warning); }
		.stat-value.dead { color: var(--danger); }
		.stat-value.won { color: var(--primary); }
		
		.user-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 15px;
		}
		.user-table th,
		.user-table td {
			padding: 12px;
			text-align: left;
			border-bottom: 1px solid var(--border);
		}
		.user-table th {
			background: var(--bg-secondary);
			font-weight: 600;
			color: var(--text-primary);
		}
		.user-table tr:hover {
			background: var(--bg-secondary);
		}
		.progress-bar {
			width: 100px;
			height: 8px;
			background: var(--bg-tertiary);
			border-radius: 4px;
			overflow: hidden;
		}
		.progress-fill {
			height: 100%;
			background: var(--primary);
			transition: width 0.3s ease;
		}
		.chart-container {
			background: var(--bg-card);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			padding: 20px;
			margin-bottom: 20px;
		}
		.tab-container {
			margin-bottom: 20px;
		}
		.tab-buttons {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
		}
		.tab-btn {
			padding: 10px 20px;
			border: 1px solid var(--border);
			background: var(--bg-card);
			color: var(--text-secondary);
			border-radius: var(--radius);
			cursor: pointer;
			transition: all 0.3s ease;
		}
		.tab-btn.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
		}
	</style>
</head>
<body>
	<div class="admin-shell">
		<aside class="admin-sidebar">
			<div class="brand"><h1>TeleCRM Admin</h1></div>
			<nav>
				<a href="/admin/overview.html">Overview</a>
				<a href="/admin/users.html">Users</a>
				<a href="/admin/leads.html">Leads</a>
				<a href="/admin/campaigns.html">Campaigns</a>
				<a href="/admin/pipelines.html">Pipelines</a>
				<a href="/admin/sims.html">SIMs</a>
				<a href="/admin/call-records.html">Call Records</a>
				<a href="/admin/analytics.html">Analytics</a>
				<a href="/admin/user-performance.html" class="active">User Performance</a>
				<a href="/admin/settings.html">Settings</a>
			</nav>
		</aside>
		<main class="admin-main">
			<div class="admin-topbar">
				<h2 class="page-title">User Performance Analytics</h2>
				<div class="toolbar">
					<button class="btn" id="refresh">Refresh</button>
				</div>
			</div>

			<!-- Overview Cards -->
			<div class="performance-grid">
				<div class="performance-card">
					<h3>Overall Summary</h3>
					<div class="stat-row">
						<span class="stat-label">Total Users</span>
						<span class="stat-value" id="totalUsers">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Total Leads</span>
						<span class="stat-value" id="totalLeads">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Completed Leads</span>
						<span class="stat-value completed" id="totalCompleted">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Pending Leads</span>
						<span class="stat-value pending" id="totalPending">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Dead Leads</span>
						<span class="stat-value dead" id="totalDead">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Won Leads</span>
						<span class="stat-value won" id="totalWon">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Completion Rate</span>
						<span class="stat-value" id="overallCompletionRate">-</span>
					</div>
				</div>

				<div class="performance-card">
					<h3>Employee Summary</h3>
					<div class="stat-row">
						<span class="stat-label">Total Employees</span>
						<span class="stat-value" id="totalEmployees">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Assigned Leads</span>
						<span class="stat-value" id="totalAssignedLeads">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Completed</span>
						<span class="stat-value completed" id="employeeCompleted">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Pending</span>
						<span class="stat-value pending" id="employeePending">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Avg Completion Rate</span>
						<span class="stat-value" id="avgEmployeeCompletion">-</span>
					</div>
				</div>

				<div class="performance-card">
					<h3>Manager Summary</h3>
					<div class="stat-row">
						<span class="stat-label">Total Managers</span>
						<span class="stat-value" id="totalManagers">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Total Team Size</span>
						<span class="stat-value" id="totalTeamSize">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Total Leads</span>
						<span class="stat-value" id="managerTotalLeads">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Completed</span>
						<span class="stat-value completed" id="managerCompleted">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Pending</span>
						<span class="stat-value pending" id="managerPending">-</span>
					</div>
					<div class="stat-row">
						<span class="stat-label">Avg Completion Rate</span>
						<span class="stat-value" id="avgManagerCompletion">-</span>
					</div>
				</div>
			</div>

			<!-- Tab Navigation -->
			<div class="tab-container">
				<div class="tab-buttons">
					<button class="tab-btn active" data-tab="employees">Employees</button>
					<button class="tab-btn" data-tab="managers">Managers</button>
					<button class="tab-btn" data-tab="charts">Charts</button>
				</div>

				<!-- Employees Tab -->
				<div class="tab-content active" id="employees-tab">
					<div class="card">
						<h3>Employee Performance Details</h3>
						<table class="user-table" id="employeeTable">
							<thead>
								<tr>
									<th>Employee</th>
									<th>Manager</th>
									<th>Assigned</th>
									<th>Completed</th>
									<th>Pending</th>
									<th>Dead</th>
									<th>Won</th>
									<th>Completion Rate</th>
									<th>Conversion Rate</th>
									<th>Total Calls</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="10" class="loading">Loading employee data...</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<!-- Managers Tab -->
				<div class="tab-content" id="managers-tab">
					<div class="card">
						<h3>Manager Performance Details</h3>
						<table class="user-table" id="managerTable">
							<thead>
								<tr>
									<th>Manager</th>
									<th>Team Size</th>
									<th>Total Leads</th>
									<th>Created</th>
									<th>Team Assigned</th>
									<th>Completed</th>
									<th>Pending</th>
									<th>Dead</th>
									<th>Won</th>
									<th>Completion Rate</th>
									<th>Team Calls</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="11" class="loading">Loading manager data...</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<!-- Charts Tab -->
				<div class="tab-content" id="charts-tab">
					<div class="chart-container">
						<h3>Completion Rate Comparison</h3>
						<canvas id="completionChart"></canvas>
					</div>
					<div class="chart-container">
						<h3>Lead Status Distribution</h3>
						<canvas id="statusChart"></canvas>
					</div>
				</div>
			</div>
		</main>
	</div>
	<script src="../assets/admin.js"></script>
	<script>
		Admin.navActivate('/admin/user-performance.html');
		let performanceData = null;
		let charts = {};

		// Tab functionality
		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
				
				btn.classList.add('active');
				document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
				
				if (btn.dataset.tab === 'charts' && performanceData) {
					renderCharts();
				}
			});
		});

		async function loadPerformanceData() {
			try {
				const response = await fetch('/api/admin/analytics/user-performance-overview', {
					headers: Admin.authHeaders()
				});
				
				if (response.ok) {
					performanceData = await response.json();
					updateOverview();
					renderEmployeeTable();
					renderManagerTable();
				} else {
					console.error('Failed to load performance data');
				}
			} catch (error) {
				console.error('Error loading performance data:', error);
			}
		}

		function updateOverview() {
			const { overview, employees, managers } = performanceData;
			
			// Overall summary
			document.getElementById('totalUsers').textContent = overview.totalUsers;
			document.getElementById('totalLeads').textContent = overview.totalLeads;
			document.getElementById('totalCompleted').textContent = overview.totalCompleted;
			document.getElementById('totalPending').textContent = overview.totalPending;
			document.getElementById('totalDead').textContent = overview.totalDead;
			document.getElementById('totalWon').textContent = overview.totalWon;
			document.getElementById('overallCompletionRate').textContent = overview.overallCompletionRate + '%';
			
			// Employee summary
			document.getElementById('totalEmployees').textContent = employees.summary.totalEmployees;
			document.getElementById('totalAssignedLeads').textContent = employees.summary.totalAssignedLeads;
			document.getElementById('employeeCompleted').textContent = employees.summary.totalCompletedLeads;
			document.getElementById('employeePending').textContent = employees.summary.totalPendingLeads;
			document.getElementById('avgEmployeeCompletion').textContent = employees.summary.avgCompletionRate + '%';
			
			// Manager summary
			document.getElementById('totalManagers').textContent = managers.summary.totalManagers;
			document.getElementById('totalTeamSize').textContent = managers.summary.totalTeamSize;
			document.getElementById('managerTotalLeads').textContent = managers.summary.totalLeads;
			document.getElementById('managerCompleted').textContent = managers.summary.totalCompletedLeads;
			document.getElementById('managerPending').textContent = managers.summary.totalPendingLeads;
			document.getElementById('avgManagerCompletion').textContent = managers.summary.avgCompletionRate + '%';
		}

		function renderEmployeeTable() {
			const tbody = document.querySelector('#employeeTable tbody');
			tbody.innerHTML = '';
			
			performanceData.employees.employeeStats.forEach(emp => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td><strong>${emp.employee.name}</strong><br><small>${emp.employee.email}</small></td>
					<td>${emp.employee.manager ? emp.employee.manager.name : 'No Manager'}</td>
					<td>${emp.stats.totalAssigned}</td>
					<td class="completed">${emp.stats.completed}</td>
					<td class="pending">${emp.stats.pending}</td>
					<td class="dead">${emp.stats.dead}</td>
					<td class="won">${emp.stats.won}</td>
					<td>${emp.stats.completionRate}%</td>
					<td>${emp.stats.conversionRate}%</td>
					<td>${emp.stats.totalCalls}</td>
				`;
				tbody.appendChild(row);
			});
		}

		function renderManagerTable() {
			const tbody = document.querySelector('#managerTable tbody');
			tbody.innerHTML = '';
			
			performanceData.managers.managerStats.forEach(mgr => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td><strong>${mgr.manager.name}</strong><br><small>${mgr.manager.email}</small></td>
					<td>${mgr.stats.teamSize}</td>
					<td>${mgr.stats.totalLeads}</td>
					<td>${mgr.stats.createdLeads}</td>
					<td>${mgr.stats.teamAssignedLeads}</td>
					<td class="completed">${mgr.stats.completed}</td>
					<td class="pending">${mgr.stats.pending}</td>
					<td class="dead">${mgr.stats.dead}</td>
					<td class="won">${mgr.stats.won}</td>
					<td>${mgr.stats.completionRate}%</td>
					<td>${mgr.stats.totalTeamCalls}</td>
				`;
				tbody.appendChild(row);
			});
		}

		function renderCharts() {
			// Completion Rate Comparison Chart
			const completionCtx = document.getElementById('completionChart').getContext('2d');
			if (charts.completion) charts.completion.destroy();
			
			charts.completion = new Chart(completionCtx, {
				type: 'bar',
				data: {
					labels: ['Employees', 'Managers'],
					datasets: [{
						label: 'Average Completion Rate (%)',
						data: [
							performanceData.employees.summary.avgCompletionRate,
							performanceData.managers.summary.avgCompletionRate
						],
						backgroundColor: ['#6366f1', '#10b981'],
						borderColor: ['#4f46e5', '#059669'],
						borderWidth: 1
					}]
				},
				options: {
					responsive: true,
					scales: {
						y: {
							beginAtZero: true,
							max: 100
						}
					}
				}
			});

			// Lead Status Distribution Chart
			const statusCtx = document.getElementById('statusChart').getContext('2d');
			if (charts.status) charts.status.destroy();
			
			charts.status = new Chart(statusCtx, {
				type: 'doughnut',
				data: {
					labels: ['Completed', 'Pending', 'Dead', 'Won'],
					datasets: [{
						data: [
							performanceData.overview.totalCompleted,
							performanceData.overview.totalPending,
							performanceData.overview.totalDead,
							performanceData.overview.totalWon
						],
						backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6366f1'],
						borderWidth: 2,
						borderColor: '#ffffff'
					}]
				},
				options: {
					responsive: true,
					plugins: {
						legend: {
							position: 'bottom'
						}
					}
				}
			});
		}

		// Event listeners
		document.getElementById('refresh').addEventListener('click', loadPerformanceData);
		
		// Load data on page load
		if (Admin.getToken()) loadPerformanceData();
	</script>
</body>
</html>
