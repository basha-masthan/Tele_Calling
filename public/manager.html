<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Manager Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #1a1a1a;
  }

  /* Header */
  header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  header h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.9);
    color: #667eea;
    border: 2px solid rgba(102, 126, 234, 0.2);
  }

  .btn-secondary:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.4);
    transform: translateY(-1px);
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
  }

  .btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
  }

  .btn-ghost {
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: #667eea;
  }

  .btn-ghost:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
  }

  /* Main Content */
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 30px 20px;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #667eea, #764ba2);
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
  }

  .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 15px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    font-size: 20px;
  }

  .stat-number {
    font-size: 32px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 5px;
  }

  .stat-label {
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
  }

  /* Cards */
  .card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(102, 126, 234, 0.1);
  }

  .card-title {
    font-size: 22px;
    font-weight: 700;
    color: #1a1a1a;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-subtitle {
    color: #6b7280;
    font-size: 14px;
    margin-top: 5px;
  }

  /* Tables */
  .table-container {
    overflow-x: auto;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 15px;
    overflow: hidden;
  }

  th {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    padding: 18px 15px;
    text-align: left;
    font-weight: 700;
    color: #374151;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e5e7eb;
  }

  td {
    padding: 18px 15px;
    border-bottom: 1px solid #f3f4f6;
    color: #374151;
    font-size: 14px;
    transition: background-color 0.2s ease;
  }

  tr:hover td {
    background-color: rgba(102, 126, 234, 0.05);
  }

  tr:last-child td {
    border-bottom: none;
  }

  .employee-row {
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .employee-row:hover {
    background: rgba(102, 126, 234, 0.08);
    transform: scale(1.01);
  }

  /* Status badges */
  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-new { background: #dbeafe; color: #1d4ed8; }
  .status-follow-up { background: #fef3c7; color: #d97706; }
  .status-converted { background: #d1fae5; color: #059669; }
  .status-lost { background: #fee2e2; color: #dc2626; }

  /* Action buttons in tables */
  .table-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .btn-sm {
    padding: 8px 12px;
    font-size: 12px;
    border-radius: 8px;
  }

  /* Modals */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    animation: fadeIn 0.3s ease;
  }

  .modal.show {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-content {
    background: white;
    padding: 35px;
    border-radius: 20px;
    width: 100%;
    max-width: 550px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
    position: relative;
  }

  .modal-header {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f3f4f6;
  }

  .modal-title {
    font-size: 24px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 5px;
  }

  .modal-subtitle {
    color: #6b7280;
    font-size: 14px;
  }

  /* Form elements */
  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    color: #374151;
    font-weight: 600;
    font-size: 14px;
  }

  input, select, textarea {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: #fafafa;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    background: white;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
  }

  textarea {
    resize: vertical;
    min-height: 100px;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #f3f4f6;
  }

  /* Audio player styling */
  audio {
    width: 100%;
    border-radius: 10px;
    background: #f8fafc;
    padding: 10px;
  }

  /* Loading states */
  .loading {
    text-align: center;
    padding: 40px;
    color: #6b7280;
  }

  .loading i {
    animation: spin 1s linear infinite;
    font-size: 24px;
    margin-bottom: 10px;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Empty states */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 8px;
    color: #374151;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .container {
      padding: 20px 15px;
    }
    
    .dashboard-grid {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .card {
      padding: 20px;
    }
    
    .modal-content {
      padding: 25px;
      margin: 10px;
    }
    
    header {
      padding: 15px 20px;
      flex-direction: column;
      gap: 15px;
      text-align: center;
    }
    
    .header-actions {
      width: 100%;
      justify-content: center;
    }
    
    table {
      font-size: 12px;
    }
    
    th, td {
      padding: 12px 8px;
    }
    
    .table-actions {
      flex-direction: column;
      gap: 4px;
    }
  }

  /* Additional animations */
  .fade-in {
    animation: fadeIn 0.5s ease;
  }

  .slide-up {
    animation: slideUp 0.5s ease;
  }

  /* Notification styles */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    z-index: 2000;
    transform: translateX(400px);
    transition: transform 0.3s ease;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification.success {
    background: linear-gradient(135deg, #059669, #047857);
  }

  .notification.error {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
  }
</style>
</head>
<body>
  <header>
    <div>
      <h1><i class="fas fa-chart-line"></i> Manager Dashboard</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button class="btn btn-ghost" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <div class="container">
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-number" id="totalEmployees">0</div>
        <div class="stat-label">Total Employees</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-user-tie"></i>
        </div>
        <div class="stat-number" id="totalLeads">0</div>
        <div class="stat-label">Total Leads</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-phone"></i>
        </div>
        <div class="stat-number" id="totalCalls">0</div>
        <div class="stat-label">Total Calls</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-number" id="conversionRate">0%</div>
        <div class="stat-label">Conversion Rate</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <!-- Employees Section -->
      <div class="card">
        <div class="card-header">
          <div>
            <h3 class="card-title">
              <i class="fas fa-users"></i> My Team
            </h3>
            <div class="card-subtitle">Click an employee to view their leads</div>
          </div>
        </div>
        <div class="table-container">
          <table id="employeesTable">
            <thead>
              <tr>
                <th><i class="fas fa-user"></i> Name</th>
                <th><i class="fas fa-envelope"></i> Email</th>
                <th><i class="fas fa-calendar"></i> Joined</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Call Logs Section -->
      <div class="card">
        <div class="card-header">
          <div>
            <h3 class="card-title">
              <i class="fas fa-phone-alt"></i> Team Call Logs
            </h3>
            <div class="card-subtitle">Recent call activity from your team</div>
          </div>
        </div>
        <div class="table-container">
          <table id="callLogsTable">
            <thead>
              <tr>
                <th><i class="fas fa-user"></i> Employee</th>
                <th><i class="fas fa-user-tie"></i> Lead</th>
                <th><i class="fas fa-info-circle"></i> Status</th>
                <th><i class="fas fa-clock"></i> When</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Leads Section -->
    <div class="card">
      <div class="card-header">
        <div>
          <h3 class="card-title">
            <i class="fas fa-user-tie"></i> Lead Management
          </h3>
          <div class="card-subtitle">Manage and assign leads to your team</div>
        </div>
        <button class="btn btn-primary" id="openCreateLeadBtn">
          <i class="fas fa-plus"></i> Create Lead
        </button>
      </div>
      <div class="table-container">
        <table id="leadsTable">
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Name</th>
              <th><i class="fas fa-phone"></i> Phone</th>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-flag"></i> Status</th>
              <th><i class="fas fa-user-check"></i> Assigned To</th>
              <th><i class="fas fa-cog"></i> Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Assign Modal -->
  <div class="modal" id="assignModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-user-plus"></i> Assign Lead</h3>
        <div class="modal-subtitle">Choose an employee to assign this lead to</div>
      </div>
      <input type="hidden" id="assignLeadId">
      <div class="form-group">
        <label for="assignEmployee"><i class="fas fa-user"></i> Choose Employee</label>
        <select id="assignEmployee">
          <option value="">Loading...</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="assignCancel">Cancel</button>
        <button class="btn btn-primary" id="assignConfirm">
          <i class="fas fa-check"></i> Assign
        </button>
      </div>
    </div>
  </div>

  <!-- Create Lead Modal -->
  <div class="modal" id="createLeadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-plus-circle"></i> Create New Lead</h3>
        <div class="modal-subtitle">Add a new lead to your pipeline</div>
      </div>
      <div class="form-group">
        <label><i class="fas fa-user"></i> Name</label>
        <input id="createName" placeholder="Enter lead name" />
      </div>
      <div class="form-group">
        <label><i class="fas fa-phone"></i> Phone</label>
        <input id="createPhone" placeholder="Enter phone number" />
      </div>
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <input id="createEmail" placeholder="Enter email address" />
      </div>
      <div class="form-group">
        <label><i class="fas fa-sticky-note"></i> Notes</label>
        <textarea id="createNotes" placeholder="Add any additional notes..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="createCancel">Cancel</button>
        <button class="btn btn-primary" id="createSave">
          <i class="fas fa-save"></i> Save Lead
        </button>
      </div>
    </div>
  </div>

  <!-- Lead Details Modal -->
  <div class="modal" id="leadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="leadModalTitle"></h3>
        <div class="modal-subtitle" id="leadMeta"></div>
      </div>
      <div class="form-group">
        <label><i class="fas fa-flag"></i> Status</label>
        <select id="leadStatus">
          <option value="New">New</option>
          <option value="Follow-up">Follow-up</option>
          <option value="Converted">Converted</option>
          <option value="Lost">Lost</option>
        </select>
      </div>
      <div class="form-group">
        <label><i class="fas fa-sticky-note"></i> Notes</label>
        <textarea id="leadNotes" placeholder="Add notes about this lead..."></textarea>
      </div>
      <div class="form-group">
        <label><i class="fas fa-microphone"></i> Recording</label>
        <div id="recordingContainer"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="leadCancel">Close</button>
        <button class="btn btn-primary" id="leadSave">
          <i class="fas fa-save"></i> Update Lead
        </button>
      </div>
    </div>
  </div>

  <script>
    // Enhanced notification system
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Enhanced loading states
    function setTableLoading(tableId, colspan = 6) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = `
        <tr>
          <td colspan="${colspan}" class="loading">
            <i class="fas fa-spinner"></i>
            <div>Loading...</div>
          </td>
        </tr>
      `;
    }

    function setTableEmpty(tableId, message, colspan = 6) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = `
        <tr>
          <td colspan="${colspan}" class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>${message}</h3>
            <div>No data available at the moment</div>
          </td>
        </tr>
      `;
    }

    function setTableError(tableId, error, colspan = 6) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = `
        <tr>
          <td colspan="${colspan}" class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Data</h3>
            <div>${error}</div>
          </td>
        </tr>
      `;
    }

    const ENDPOINTS = {
      employees: '/api/manager/employees',
      myLeads: '/api/manager/leads',
      leadById: '/api/manager/lead',
      employeeLeads: '/api/manager/employee',
      teamCallLogs: '/api/manager/team-call-logs',
      assignLead: '/api/manager/assign-lead',
      createLead: '/api/manager/create-lead',
      updateLead: '/api/manager/lead',
      deleteLead: '/api/manager/lead'
    };

    function authHeader() {
      const token = localStorage.getItem('token');
      return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    function handleErrResponse(res) {
      return res.json().then(payload => {
        const msg = payload?.message || payload?.error || res.statusText;
        throw new Error(msg);
      }).catch(e => { throw e; });
    }

    // Enhanced modal controls
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // Enhanced employees loading
    async function loadEmployees() {
      setTableLoading('employeesTable', 3);
      try {
        const res = await fetch(ENDPOINTS.employees, { headers: authHeader() });
        if (!res.ok) await handleErrResponse(res);
        const employees = await res.json();
        
        document.getElementById('totalEmployees').textContent = employees.length;
        
        if (!employees.length) { 
          setTableEmpty('employeesTable', 'No employees found', 3); 
          return; 
        }
        
        const tbody = document.querySelector('#employeesTable tbody');
        tbody.innerHTML = '';
        
        employees.forEach((emp, index) => {
          const tr = document.createElement('tr');
          tr.className = 'employee-row fade-in';
          tr.style.animationDelay = `${index * 0.1}s`;
          tr.innerHTML = `
            <td><strong>${emp.name}</strong></td>
            <td>${emp.email}</td>
            <td>${new Date(emp.createdAt).toLocaleDateString()}</td>
          `;
          tr.addEventListener('click', () => showEmployeeLeads(emp._id, emp.name));
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        setTableError('employeesTable', err.message, 3);
      }
    }

    async function showEmployeeLeads(empId, empName) {
      try {
        const res = await fetch(`${ENDPOINTS.employeeLeads}/${empId}/leads`, { headers: authHeader() });
        if (!res.ok) await handleErrResponse(res);
        const leads = await res.json();
        renderLeadsTable(leads);
        showNotification(`Showing leads for ${empName}`);
      } catch (err) {
        console.error(err);
        showNotification(`Error loading employee leads: ${err.message}`, 'error');
      }
    }

    // Enhanced leads rendering
    function renderLeadsTable(leads) {
      if (!leads || !leads.length) { 
        setTableEmpty('leadsTable', 'No leads found'); 
        document.getElementById('totalLeads').textContent = '0';
        return; 
      }
      
      document.getElementById('totalLeads').textContent = leads.length;
      
      const tbody = document.querySelector('#leadsTable tbody');
      tbody.innerHTML = '';
      
      leads.forEach((lead, index) => {
        const assigned = lead.assignedTo ? lead.assignedTo.name : 'Unassigned';
        const statusClass = `status-${lead.status?.toLowerCase().replace('-', '-') || 'new'}`;
        
        const tr = document.createElement('tr');
        tr.className = 'fade-in';
        tr.style.animationDelay = `${index * 0.05}s`;
        tr.innerHTML = `
          <td><strong>${lead.name}</strong></td>
          <td>${lead.phone || '-'}</td>
          <td>${lead.email || '-'}</td>
          <td><span class="status-badge ${statusClass}">${lead.status || 'New'}</span></td>
          <td>${assigned}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-sm btn-primary" data-action="assign" data-id="${lead._id}">
                <i class="fas fa-user-plus"></i> Assign
              </button>
              <button class="btn btn-sm btn-secondary" data-action="view" data-id="${lead._id}">
                <i class="fas fa-eye"></i> View
              </button>
              <button class="btn btn-sm btn-danger" data-action="delete" data-id="${lead._id}">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Delegate actions
      tbody.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          const id = btn.dataset.id;
          if (action === 'assign') openAssignModal(id);
          if (action === 'view') openLeadModal(id);
          if (action === 'delete') deleteLead(id);
        });
      });
    }

    async function loadMyLeads() {
      setTableLoading('leadsTable');
      try {
        const res = await fetch(ENDPOINTS.myLeads, { headers: authHeader() });
        if (!res.ok) await handleErrResponse(res);
        const leads = await res.json();
        renderLeadsTable(leads);
      } catch (err) {
        console.error(err);
        setTableError('leadsTable', err.message);
      }
    }

    // Enhanced team call logs
    async function loadTeamCallLogs() {
      setTableLoading('callLogsTable', 4);
      try {
        const res = await fetch(ENDPOINTS.teamCallLogs, { headers: authHeader() });
        if (!res.ok) await handleErrResponse(res);
        const logs = await res.json();
        
        document.getElementById('totalCalls').textContent = logs.length;
        
        if (!logs.length) { 
          setTableEmpty('callLogsTable', 'No call logs found', 4); 
          return; 
        }
        
        const tbody = document.querySelector('#callLogsTable tbody');
        tbody.innerHTML = '';
        
        logs.forEach((log, index) => {
          const when = new Date(log.createdAt).toLocaleString();
          const tr = document.createElement('tr');
          tr.className = 'fade-in';
          tr.style.animationDelay = `${index * 0.05}s`;
          tr.innerHTML = `
            <td><strong>${log.employee?.name || 'Unknown'}</strong></td>
            <td>${log.lead?.name || 'Unknown'}</td>
            <td><span class="status-badge status-${log.callStatus?.toLowerCase() || 'new'}">${log.callStatus || 'Unknown'}</span></td>
            <td><small>${when}</small></td>
          `;
          tbody.appendChild(tr);
        });
        
        // Calculate conversion rate
        const convertedCalls = logs.filter(log => log.callStatus?.toLowerCase().includes('converted')).length;
        const conversionRate = logs.length > 0 ? Math.round((convertedCalls / logs.length) * 100) : 0;
        document.getElementById('conversionRate').textContent = `${conversionRate}%`;
        
      } catch (err) {
        console.error(err);
        setTableError('callLogsTable', err.message, 4);
      }
    }

    // Enhanced assign modal
    function openAssignModal(leadId) {
      document.getElementById('assignLeadId').value = leadId;
      const sel = document.getElementById('assignEmployee');
      sel.innerHTML = '<option value="">Loading employees...</option>';
      
      fetch(ENDPOINTS.employees, { headers: authHeader() })
        .then(async res => { 
          if (!res.ok) await handleErrResponse(res); 
          return res.json(); 
        })
        .then(emps => {
          sel.innerHTML = '<option value="">-- Select employee --</option>';
          emps.forEach(e => {
            sel.innerHTML += `<option value="${e._id}">${e.name} (${e.email})</option>`;
          });
          showModal('assignModal');
        }).catch(err => {
          showNotification('Failed to load employees: ' + err.message, 'error');
        });
    }

    document.getElementById('assignCancel').addEventListener('click', () => hideModal('assignModal'));
    document.getElementById('assignConfirm').addEventListener('click', async () => {
      const leadId = document.getElementById('assignLeadId').value;
      const employeeId = document.getElementById('assignEmployee').value;
      
      if (!employeeId) {
        showNotification('Please select an employee', 'error');
        return;
      }

      try {
        const res = await fetch(ENDPOINTS.assignLead, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeader() },
          body: JSON.stringify({ leadId, employeeId })
        });
        if (!res.ok) await handleErrResponse(res);
        await res.json();
        
        hideModal('assignModal');
        showNotification('Lead assigned successfully!');
        await loadMyLeads();
        await loadEmployees();
      } catch (err) {
        showNotification('Assignment failed: ' + err.message, 'error');
      }
    });

    // Enhanced create lead modal
    document.getElementById('openCreateLeadBtn').addEventListener('click', () => {
      // Clear form
      document.getElementById('createName').value = '';
      document.getElementById('createPhone').value = '';
      document.getElementById('createEmail').value = '';
      document.getElementById('createNotes').value = '';
      showModal('createLeadModal');
    });

    document.getElementById('createCancel').addEventListener('click', () => hideModal('createLeadModal'));
    document.getElementById('createSave').addEventListener('click', async () => {
      const name = document.getElementById('createName').value.trim();
      const phone = document.getElementById('createPhone').value.trim();
      const email = document.getElementById('createEmail').value.trim();
      const notes = document.getElementById('createNotes').value.trim();
      
      if (!name || !phone) {
        showNotification('Name and phone are required', 'error');
        return;
      }
      
      try {
        const res = await fetch(ENDPOINTS.createLead, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeader() },
          body: JSON.stringify({ name, phone, email, notes })
        });
        if (!res.ok) await handleErrResponse(res);
        await res.json();
        
        hideModal('createLeadModal');
        showNotification('Lead created successfully!');
        await loadMyLeads();
      } catch (err) {
        showNotification('Failed to create lead: ' + err.message, 'error');
      }
    });

    // Enhanced lead modal
    async function openLeadModal(leadId) {
      try {
        const res = await fetch(`${ENDPOINTS.leadById}/${leadId}`, { headers: authHeader() });
        if (!res.ok) await handleErrResponse(res);
        const lead = await res.json();
        
        document.getElementById('leadModalTitle').innerHTML = `<i class="fas fa-user-tie"></i> ${lead.name}`;
        document.getElementById('leadMeta').textContent = `Phone: ${lead.phone || 'N/A'}  â€¢  Created by: ${lead.createdBy?.name || 'Unknown'}`;
        
        // Status select
        const statusSel = document.getElementById('leadStatus');
        statusSel.innerHTML = '';
        ['New', 'Follow-up', 'Converted', 'Lost'].forEach(s => {
          const option = document.createElement('option');
          option.value = s;
          option.textContent = s;
          option.selected = s === lead.status;
          statusSel.appendChild(option);
        });
        
        document.getElementById('leadNotes').value = lead.notes || '';

        // Recording
        const rc = document.getElementById('recordingContainer');
        if (lead.recordingUrl) {
          rc.innerHTML = `<audio controls src="${lead.recordingUrl}"></audio>`;
        } else {
          rc.innerHTML = '<div class="empty-state"><i class="fas fa-microphone-slash"></i><div>No recording available</div></div>';
        }

        document.getElementById('leadModal').dataset.leadId = lead._id;
        showModal('leadModal');
      } catch (err) {
        showNotification('Failed to load lead: ' + err.message, 'error');
      }
    }

    document.getElementById('leadCancel').addEventListener('click', () => hideModal('leadModal'));
    document.getElementById('leadSave').addEventListener('click', async () => {
      const leadId = document.getElementById('leadModal').dataset.leadId;
      const status = document.getElementById('leadStatus').value;
      const notes = document.getElementById('leadNotes').value;
      
      try {
        const res = await fetch(`${ENDPOINTS.updateLead}/${leadId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeader() },
          body: JSON.stringify({ status, notes })
        });
        if (!res.ok) await handleErrResponse(res);
        await res.json();
        
        hideModal('leadModal');
        showNotification('Lead updated successfully!');
        await loadMyLeads();
      } catch (err) {
        showNotification('Update failed: ' + err.message, 'error');
      }
    });

    // Enhanced delete function
    async function deleteLead(leadId) {
      if (!confirm('Are you sure you want to delete this lead? This action cannot be undone.')) return;
      
      try {
        const res = await fetch(`${ENDPOINTS.deleteLead}/${leadId}`, {
          method: 'DELETE',
          headers: authHeader()
        });
        if (!res.ok) await handleErrResponse(res);
        await res.json();
        
        showNotification('Lead deleted successfully!');
        await loadMyLeads();
      } catch (err) {
        showNotification('Delete failed: ' + err.message, 'error');
      }
    }

    // Enhanced event listeners
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      showNotification('Refreshing data...');
      await Promise.all([loadEmployees(), loadMyLeads(), loadTeamCallLogs()]);
      showNotification('Data refreshed successfully!');
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        showNotification('Logged out successfully');
        setTimeout(() => location.href = '/login.html', 1000);
      }
    });

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        const modals = ['assignModal', 'createLeadModal', 'leadModal'];
        modals.forEach(modalId => hideModal(modalId));
      }
    });

    // Enhanced initialization
    (async function init() {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role');
      
      if (!token || (role !== 'manager' && role !== 'admin')) {
        showNotification('Unauthorized access', 'error');
        setTimeout(() => location.href = '/login.html', 2000);
        return;
      }

      // Show welcome message
      showNotification('Welcome to Manager Dashboard!');
      
      // Load all data
      try {
        await Promise.all([loadEmployees(), loadMyLeads(), loadTeamCallLogs()]);
      } catch (err) {
        console.error('Initialization error:', err);
        showNotification('Failed to load dashboard data', 'error');
      }
    })();

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // ESC to close modals
      if (e.key === 'Escape') {
        const modals = ['assignModal', 'createLeadModal', 'leadModal'];
        modals.forEach(modalId => hideModal(modalId));
      }
      
      // Ctrl+N to create new lead
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        document.getElementById('openCreateLeadBtn').click();
      }
      
      // F5 to refresh
      if (e.key === 'F5') {
        e.preventDefault();
        document.getElementById('refreshBtn').click();
      }
    });

    // Auto-refresh every 5 minutes
    setInterval(() => {
      loadTeamCallLogs();
    }, 5 * 60 * 1000);

  </script>
</body>
</html>