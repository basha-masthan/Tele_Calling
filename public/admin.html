<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<style>
:root {
  --primary: #2563eb;
  --primary-hover: #1d4ed8;
  --secondary: #64748b;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --bg-primary: #ffffff;
  --bg-secondary: #f8fafc;
  --bg-tertiary: #f1f5f9;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --border-hover: #cbd5e1;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --radius: 8px;
  --radius-lg: 12px;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

.dashboard {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 260px;
  background: var(--bg-primary);
  border-right: 1px solid var(--border);
  padding: 24px 0;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 0 24px 24px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 24px;
}

.sidebar-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.sidebar-subtitle {
  font-size: 12px;
  color: var(--text-muted);
  margin: 4px 0 0;
}

.nav-menu {
  list-style: none;
  padding: 0 12px;
  margin: 0;
}

.nav-item {
  margin-bottom: 4px;
}

.nav-link {
  display: block;
  padding: 12px 16px;
  color: var(--text-secondary);
  text-decoration: none;
  border-radius: var(--radius);
  transition: all 0.2s ease;
  cursor: pointer;
  font-weight: 500;
}

.nav-link:hover,
.nav-link.active {
  background: var(--bg-tertiary);
  color: var(--primary);
}

/* Main Content */
.main-content {
  flex: 1;
  padding: 32px;
  overflow-y: auto;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

.page-header {
  margin-bottom: 32px;
}

.page-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0 0 8px;
}

.page-subtitle {
  color: var(--text-secondary);
  margin: 0;
}

/* Cards */
.card {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  margin-bottom: 24px;
  overflow: hidden;
}

.card-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.card-content {
  padding: 24px;
}

/* Tables */
.table-container {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: var(--bg-primary);
}

th {
  background: var(--bg-secondary);
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

td {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  color: var(--text-primary);
}

tr:hover {
  background: var(--bg-tertiary);
}

tr.clickable {
  cursor: pointer;
  position: relative;
}

tr.clickable::after {
  content: 'â–¶';
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 12px;
  transition: transform 0.2s ease;
}

tr.clickable.expanded::after {
  transform: translateY(-50%) rotate(90deg);
}

/* Accordion Employee Rows */
.employee-accordion {
  background: var(--bg-secondary);
  display: none;
}

.employee-accordion.show {
  display: table-row;
}

.employee-accordion td {
  padding: 0;
  border-bottom: 1px solid var(--border);
}

.employee-accordion-content {
  padding: 20px;
  background: var(--bg-secondary);
}

.employee-accordion-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 12px;
  font-size: 14px;
}

.employee-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 12px;
}

.employee-card {
  background: var(--bg-primary);
  padding: 12px 16px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  transition: all 0.2s ease;
}

.employee-card:hover {
  border-color: var(--border-hover);
  box-shadow: var(--shadow-sm);
}

.employee-card-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.employee-card-email {
  font-size: 13px;
  color: var(--text-secondary);
}

.no-employees {
  text-align: center;
  padding: 20px;
  color: var(--text-muted);
  font-style: italic;
}

/* Forms */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  align-items: start;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.form-input,
.form-select {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-size: 14px;
  transition: border-color 0.2s ease;
  background: var(--bg-primary);
  color: var(--text-primary);
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
}

/* Employee List */
.employees-container {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-primary);
}

.employee-item {
  display: flex;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid var(--border);
  transition: background-color 0.2s ease;
}

.employee-item:last-child {
  border-bottom: none;
}

.employee-item:hover {
  background: var(--bg-secondary);
}

.employee-checkbox {
  margin-right: 12px;
  width: 16px;
  height: 16px;
}

.employee-info {
  flex: 1;
}

.employee-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.employee-details {
  font-size: 12px;
  color: var(--text-secondary);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border: 1px solid transparent;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  background: transparent;
}

.btn-primary {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.btn-primary:hover {
  background: var(--primary-hover);
  border-color: var(--primary-hover);
}

.btn-secondary {
  background: var(--bg-primary);
  color: var(--text-primary);
  border-color: var(--border);
}

.btn-secondary:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
}

.btn-outline {
  background: transparent;
  color: var(--primary);
  border-color: var(--primary);
}

.btn-outline:hover {
  background: var(--primary);
  color: white;
}

.btn-group {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

/* Status Messages */
.status-message {
  padding: 12px 16px;
  border-radius: var(--radius);
  font-size: 14px;
  margin-top: 16px;
}

.status-success {
  background: rgb(16 185 129 / 0.1);
  color: var(--success);
  border: 1px solid rgb(16 185 129 / 0.2);
}

.status-error {
  background: rgb(239 68 68 / 0.1);
  color: var(--danger);
  border: 1px solid rgb(239 68 68 / 0.2);
}

.status-info {
  background: rgb(37 99 235 / 0.1);
  color: var(--primary);
  border: 1px solid rgb(37 99 235 / 0.2);
}

/* Assignments Display */
.assignments-list {
  margin-top: 20px;
}

.manager-group {
  margin-bottom: 24px;
}

.manager-group-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--border);
}

.employee-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.employee-list li {
  padding: 8px 0;
  color: var(--text-secondary);
  font-size: 14px;
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar {
    display: none;
  }
  
  .main-content {
    padding: 20px;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .page-title {
    font-size: 24px;
  }
}

/* Loading States */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--text-muted);
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}
</style>
</head>
<body>

<div class="dashboard">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1 class="sidebar-title">Admin Panel</h1>
      <p class="sidebar-subtitle">Employee Management System</p>
    </div>
    
    <nav>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link active" onclick="showSection('managers')">Managers</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="showSection('employees')">Employees</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="showSection('leads')">Leads</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="showSection('assign')">Assign Employees</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="showSection('lead-assign')">Lead Employees</a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Managers Section -->
    <section id="managers" class="section active">
      <div class="page-header">
        <h1 class="page-title">Managers</h1>
        <p class="page-subtitle">View and manage all managers in the system</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">All Managers</h2>
        </div>
        <div class="card-content">
          <div class="table-container">
            <table id="managersTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Created At</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>


    </section>

    <!-- Employees Section -->
    <section id="employees" class="section">
      <div class="page-header">
        <h1 class="page-title">Employees</h1>
        <p class="page-subtitle">View all employees and their assigned managers</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">All Employees</h2>
        </div>
        <div class="card-content">
          <div class="table-container">
            <table id="employeesTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Manager</th>
                  <th>Created At</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Leads Section -->
    <section id="leads" class="section">
      <div class="page-header">
        <h1 class="page-title">Leads</h1>
        <p class="page-subtitle">Manage all leads and prospects</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">All Leads</h2>
        </div>
        <div class="card-content">
          <div class="table-container">
            <table id="leadsTable">
              <thead id="leadsHead"></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Assign Section -->
    <section id="assign" class="section">
      <div class="page-header">
        <h1 class="page-title">Assign Employees</h1>
        <p class="page-subtitle">Choose a manager and assign one or more employees to them</p>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Assignment Tool</h2>
        </div>
        <div class="card-content">
          <div class="form-grid">
            <!-- Left: Manager selection and controls -->
            <div>
              <div class="form-group">
                <label class="form-label" for="managerSelect">Select Manager</label>
                <select id="managerSelect" class="form-select">
                  <option value="">Loading managers...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="searchEmployees">Search Employees</label>
                <input type="text" id="searchEmployees" class="form-input" placeholder="Search by name or email">
              </div>

              <div class="btn-group">
                <button id="assignBtn" class="btn btn-primary">Assign Selected</button>
                <button id="clearBtn" class="btn btn-secondary">Clear Selection</button>
                <button id="refreshBtn" class="btn btn-outline">Refresh</button>
              </div>

              <div id="statusMsg" class="status-message" style="display: none;" aria-live="polite"></div>
            </div>

            <!-- Right: Employees list -->
            <div>
              <label class="form-label">Available Employees</label>
              <div class="employees-container" id="employeesList">
                <div class="loading">Loading employees...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Current Assignments</h2>
        </div>
        <div class="card-content">
          <div id="assignmentsContainer" class="loading">Loading assignments...</div>
        </div>
      </div>
    </section>

            <!-- Lead Assign Section -->
<section id="lead-assign" class="section">
  <div class="page-header">
    <h1 class="page-title">Assign Leads</h1>
    <p class="page-subtitle">Choose a user (employee) and assign one or more leads to them</p>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Lead Assignment Tool</h2>
    </div>
    <div class="card-content">
      <div class="form-grid">
        <!-- Left: User selection and controls -->
        <div>
          <div class="form-group">
            <label class="form-label" for="userSelect">Select User</label>
            <select id="userSelect" class="form-select">
              <option value="">Loading users...</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="searchLeads">Search Leads</label>
            <input type="text" id="searchLeads" class="form-input" placeholder="Search by name or email">
          </div>

          <div class="btn-group">
            <button id="leadAssignBtn" class="btn btn-primary">Assign Selected</button>
            <button id="leadClearBtn" class="btn btn-secondary">Clear Selection</button>
            <button id="leadRefreshBtn" class="btn btn-outline">Refresh</button>
          </div>

          <div id="leadStatusMsg" class="status-message" style="display: none;" aria-live="polite"></div>
        </div>

        <!-- Right: Leads list -->
        <div>
          <label class="form-label">Available Leads</label>
          <div class="employees-container" id="leadsList">
            <div class="loading">Loading leads...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Assignments -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Current Lead Assignments</h2>
    </div>
    <div class="card-content">
      <div id="leadAssignmentsContainer" class="loading">Loading assignments...</div>
    </div>
  </div>  
</section>

<!-- Script for Lead Assignment -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const userSelect = document.getElementById("userSelect");
  const leadsList = document.getElementById("leadsList");
  const assignmentsContainer = document.getElementById("leadAssignmentsContainer");
  const searchLeads = document.getElementById("searchLeads");
  const statusMsg = document.getElementById("leadStatusMsg");

  async function fetchUsers() {
    try {
      const res = await fetch("/api/leads/users");
      const users = await res.json();
      userSelect.innerHTML = `<option value="">-- Select User --</option>`;
      users.forEach(user => {
        userSelect.innerHTML += `<option value="${user._id}">${user.name} (${user.email})</option>`;
      });
    } catch (err) {
      console.error("Error fetching users", err);
    }
  }

  async function fetchLeads() {
    try {
      const res = await fetch("/api/leads/unassigned");
      const leads = await res.json();
      renderLeads(leads);
    } catch (err) {
      console.error("Error fetching leads", err);
    }
  }

  function renderLeads(leads) {
    leadsList.innerHTML = "";
    if (!leads.length) {
      leadsList.innerHTML = "<p>No unassigned leads bhai.</p>";
      return;
    }
    leads.forEach(lead => {
      leadsList.innerHTML += `
        <label class="checkbox-item">
          <input type="checkbox" value="${lead._id}" />
          <span>${lead.name} - ${lead.email || 'No email'} - ${lead.phone}</span>
        </label>
      `;
    });
  }

  async function fetchAssignments() {
    try {
      const res = await fetch("/api/leads/assignments");
      const assignments = await res.json();
      assignmentsContainer.innerHTML = "";
      if (!assignments.length) {
        assignmentsContainer.innerHTML = "<p>No assigned leads found.</p>";
        return;
      }
      assignments.forEach(lead => {
        assignmentsContainer.innerHTML += `
          <div class="assignment-item">
            <strong>${lead.name}</strong> - ${lead.email || 'No email'} - Assigned to: ${lead.assignedTo?.name || 'N/A'}
          </div>
        `;
      });
    } catch (err) {
      console.error("Error fetching assignments", err);
    }
  }

  document.getElementById("leadAssignBtn").addEventListener("click", async () => {
    const selectedUser = userSelect.value;
    const selectedLeads = [...leadsList.querySelectorAll("input[type=checkbox]:checked")].map(cb => cb.value);

    if (!selectedUser || selectedLeads.length === 0) {
      alert("Please select a user and at least one lead.");
      return;
    }

    try {
      const res = await fetch("/api/leads/assign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: selectedUser, leadIds: selectedLeads })
      });

      const data = await res.json();
      statusMsg.textContent = data.message || "Assignment completed";
      statusMsg.style.display = "block";
      fetchLeads();
      fetchAssignments();
    } catch (err) {
      console.error("Error assigning leads", err);
    }
  });

  document.getElementById("leadClearBtn").addEventListener("click", () => {
    leadsList.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
  });

  document.getElementById("leadRefreshBtn").addEventListener("click", () => {
    fetchLeads();
    fetchAssignments();
  });

  searchLeads.addEventListener("input", async (e) => {
    const query = e.target.value.toLowerCase();
    const res = await fetch("/api/leads/unassigned");
    const leads = await res.json();
    const filtered = leads.filter(lead =>
      lead.name.toLowerCase().includes(query) ||
      (lead.email && lead.email.toLowerCase().includes(query))
    );
    renderLeads(filtered);
  });

  // Initial load
  fetchUsers();
  fetchLeads();
  fetchAssignments();
});
</script>



  </main>
</div>



<script>
// Navigation
function showSection(sectionId) {
  // Update active nav link
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Show/hide sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(sectionId).classList.add('active');
}

// Utility functions
function getAuthHeader() {
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': 'Bearer ' + token } : {};
}

function escapeHtml(str) {
  return String(str || '').replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"/":'&#x2F;', "`":'&#x60;','=':'&#x3D;'
  })[s]);
}

function showStatus(message, type = 'info') {
  const statusEl = document.getElementById('statusMsg');
  statusEl.textContent = message;
  statusEl.className = `status-message status-${type}`;
  statusEl.style.display = 'block';
}

function hideStatus() {
  const statusEl = document.getElementById('statusMsg');
  statusEl.style.display = 'none';
}

// Managers functionality
async function loadManagers() {
  try {
    const res = await fetch('/api/admin/managers', { headers: {...getAuthHeader()} });
    if (!res.ok) throw new Error('Failed to load managers');
    
    const data = await res.json();
    const tbody = document.querySelector('#managersTable tbody');
    tbody.innerHTML = '';
    
    data.forEach((manager, index) => {
      // Manager row
      const tr = document.createElement('tr');
      tr.className = 'clickable';
      tr.dataset.managerId = manager._id;
      tr.dataset.expanded = 'false';
      tr.innerHTML = `
        <td>${escapeHtml(manager.name)}</td>
        <td>${escapeHtml(manager.email)}</td>
        <td>${new Date(manager.createdAt).toLocaleDateString()}</td>
      `;
      
      // Employee accordion row (initially hidden)
      const accordionTr = document.createElement('tr');
      accordionTr.className = 'employee-accordion';
      accordionTr.id = `accordion-${manager._id}`;
      accordionTr.innerHTML = `
        <td colspan="3">
          <div class="employee-accordion-content">
            <div class="employee-accordion-title">Assigned Employees</div>
            <div id="employees-${manager._id}" class="employee-grid">
              <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
        </td>
      `;
      
      // Click handler for accordion
      tr.addEventListener('click', () => toggleManagerAccordion(manager._id, tr));
      
      tbody.appendChild(tr);
      tbody.appendChild(accordionTr);
    });
  } catch (err) {
    console.error('Error loading managers:', err);
  }
}

async function toggleManagerAccordion(managerId, managerRow) {
  const accordionRow = document.getElementById(`accordion-${managerId}`);
  const isExpanded = managerRow.dataset.expanded === 'true';
  
  if (isExpanded) {
    // Collapse
    accordionRow.classList.remove('show');
    managerRow.classList.remove('expanded');
    managerRow.dataset.expanded = 'false';
  } else {
    // Expand
    accordionRow.classList.add('show');
    managerRow.classList.add('expanded');
    managerRow.dataset.expanded = 'true';
    
    // Load employees if not already loaded
    await loadManagerEmployees(managerId);
  }
}

async function loadManagerEmployees(managerId) {
  const container = document.getElementById(`employees-${managerId}`);
  
  try {
    // Get all employees and filter by manager on frontend
    const res = await fetch('/api/admin/employees', { headers: {...getAuthHeader()} });
    if (!res.ok) throw new Error('Failed to load employees');
    
    const allEmployees = await res.json();
    // Filter employees by the selected manager
    const employees = allEmployees.filter(emp => 
      emp.manager && (emp.manager === managerId || emp.manager._id === managerId)
    );
    
    if (employees.length === 0) {
      container.innerHTML = '<div class="no-employees">No employees assigned to this manager</div>';
    } else {
      container.innerHTML = employees.map(emp => `
        <div class="employee-card">
          <div class="employee-card-name">${escapeHtml(emp.name)}</div>
          <div class="employee-card-email">${escapeHtml(emp.email)}</div>
        </div>
      `).join('');
    }
  } catch (err) {
    console.error('Error loading manager employees:', err);
    container.innerHTML = '<div class="no-employees" style="color: var(--danger);">Error loading employees</div>';
  }
}

async function showManagerEmployees(managerId) {
  // This function is kept for backward compatibility but now handled by accordion
  await loadManagerEmployees(managerId);
}

// Employees functionality
async function loadEmployees() {
  try {
    const res = await fetch('/api/admin/employees', { headers: {...getAuthHeader()} });
    if (!res.ok) throw new Error('Failed to load employees');
    
    const data = await res.json();
    const tbody = document.querySelector('#employeesTable tbody');
    tbody.innerHTML = '';
    
    data.forEach(emp => {
      const managerName = emp.manager ? emp.manager.name : 'Unassigned';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(emp.name)}</td>
        <td>${escapeHtml(emp.email)}</td>
        <td>${escapeHtml(managerName)}</td>
        <td>${new Date(emp.createdAt).toLocaleDateString()}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error('Error loading employees:', err);
  }
}

// Leads functionality
async function loadLeads() {
  try {
    const res = await fetch('/api/admin/leads', { headers: {...getAuthHeader()} });
    if (!res.ok) throw new Error('Failed to load leads');
    
    const data = await res.json();
    const thead = document.getElementById('leadsHead');
    const tbody = document.querySelector('#leadsTable tbody');

    if (data.length > 0) {
      const keys = Object.keys(data[0]).filter(k => k !== '_id');
      thead.innerHTML = `<tr>${keys.map(k => `<th>${escapeHtml(k)}</th>`).join('')}</tr>`;
      tbody.innerHTML = '';
      data.forEach(lead => {
        tbody.innerHTML += `<tr>${keys.map(k => `<td>${escapeHtml(lead[k])}</td>`).join('')}</tr>`;
      });
    }
  } catch (err) {
    console.error('Error loading leads:', err);
  }
}

// Assignment functionality 
let allEmployees = [];

async function loadManagersForAssignment() {
  const sel = document.getElementById('managerSelect');
  sel.innerHTML = '<option value="">Loading managers...</option>';

  try {
    const res = await fetch('/api/admin/managers', { headers: {...getAuthHeader()} });
    if (!res.ok) throw new Error('Failed to load managers');
    
    const data = await res.json();
    sel.innerHTML = '<option value="">-- Select Manager --</option>';
    data.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m._id;
      opt.textContent = `${m.name} (${m.email || 'no-email'})`;
      sel.appendChild(opt);
    });
  } catch (err) {
    sel.innerHTML = '<option value="">Error loading managers</option>';
    console.error('Error loading managers for assignment:', err);
  }
}

async function loadEmployeesForAssignment() {
  const container = document.getElementById('employeesList');
  container.innerHTML = '<div class="loading">Loading employees...</div>';
  
  try {
    const res = await fetch('/api/admin/employees', { headers: {...getAuthHeader()} });
    if (!res.ok) throw new Error('Failed to load employees');
    
    const data = await res.json();
    allEmployees = data;
    renderEmployeesForAssignment(data);
  } catch (err) {
    container.innerHTML = '<div class="empty-state">Error loading employees</div>';
    console.error('Error loading employees for assignment:', err);
  }
}

function renderEmployeesForAssignment(employees) {
  const container = document.getElementById('employeesList');
  
  if (!employees.length) {
    container.innerHTML = '<div class="empty-state">No employees found</div>';
    return;
  }
  
  container.innerHTML = '';
  employees.forEach(emp => {
    const item = document.createElement('div');
    item.className = 'employee-item';
    item.innerHTML = `
      <input class="employee-checkbox" type="checkbox" data-id="${emp._id}">
      <div class="employee-info">
        <div class="employee-name">${escapeHtml(emp.name || 'Unnamed')}</div>
        <div class="employee-details">
          ${escapeHtml(emp.email || 'no-email')} â€¢ 
          Manager: ${emp.manager ? escapeHtml(emp.manager.name || emp.manager) : 'Unassigned'}
        </div>
      </div>
    `;
    container.appendChild(item);
  });
}

async function loadAssignments() {
  const container = document.getElementById('assignmentsContainer');
  container.innerHTML = '<div class="loading">Loading assignments...</div>';
  
  try {
    const [mRes, eRes] = await Promise.all([
      fetch('/api/admin/managers', { headers: {...getAuthHeader()} }),
      fetch('/api/admin/employees', { headers: {...getAuthHeader()} })
    ]);
    
    if (!mRes.ok || !eRes.ok) throw new Error('Failed to load data');

    const managers = await mRes.json();
    const employees = await eRes.json();

    // Map managerId -> manager name
    const managerMap = {};
    managers.forEach(m => managerMap[m._id] = m.name);

    // Group employees by manager
    const grouped = {};
    employees.forEach(emp => {
      const managerId = emp.manager || 'unassigned';
      if (!grouped[managerId]) grouped[managerId] = [];
      grouped[managerId].push(emp);
    });

    // Render assignments
    let html = '<div class="assignments-list">';
    Object.keys(grouped).forEach(managerId => {
      const managerName = managerId === 'unassigned' ? 'Unassigned' : (managerMap[managerId] || 'Unknown Manager');
      html += `
        <div class="manager-group">
          <div class="manager-group-title">${escapeHtml(managerName)} (${grouped[managerId].length})</div>
          <ul class="employee-list">
            ${grouped[managerId].map(emp => 
              `<li>${escapeHtml(emp.name)} â€” ${escapeHtml(emp.email || 'no-email')}</li>`
            ).join('')}
          </ul>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html || '<div class="empty-state">No assignments found</div>';
  } catch (err) {
    container.innerHTML = '<div class="empty-state">Error loading assignments</div>';
    console.error('Error loading assignments:', err);
  }
}

async function assignSelected() {
  const managerId = document.getElementById('managerSelect').value;
  const checkboxes = Array.from(document.querySelectorAll('.employee-checkbox:checked'));

  if (!managerId) {
    showStatus('Please select a manager.', 'error');
    return;
  }
  
  if (!checkboxes.length) {
    showStatus('Please select at least one employee.', 'error');
    return;
  }

  showStatus('Assigning employees...', 'info');
  
  try {
    const tokenHeader = getAuthHeader();
    const results = [];
    
    for (const checkbox of checkboxes) {
      const employeeId = checkbox.getAttribute('data-id');
      const res = await fetch('/api/admin/assign-employee', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...tokenHeader },
        body: JSON.stringify({ employeeId, managerId })
      });
      const json = await res.json();
      results.push({ ok: res.ok, json });
    }

    const failed = results.filter(r => !r.ok);
    if (failed.length) {
      showStatus(`Assigned ${results.length - failed.length} / ${results.length} employees. ${failed.length} failed.`, 'error');
      console.error('Failed assignments:', failed);
    } else {
      showStatus(`Successfully assigned ${results.length} employees.`, 'success');
    }

    // Refresh data
    await Promise.all([loadEmployeesForAssignment(), loadAssignments()]);
  } catch (err) {
    console.error('Assignment error:', err);
    showStatus('Server error during assignment.', 'error');
  }
}

function clearSelection() {
  document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
  showStatus('Selection cleared.', 'info');
}

function initSearch() {
  const input = document.getElementById('searchEmployees');
  input.addEventListener('input', () => {
    const query = input.value.trim().toLowerCase();
    if (!query) {
      renderEmployeesForAssignment(allEmployees);
      return;
    }
    
    const filtered = allEmployees.filter(emp => 
      (emp.name && emp.name.toLowerCase().includes(query)) ||
      (emp.email && emp.email.toLowerCase().includes(query))
    );
    renderEmployeesForAssignment(filtered);
  });
}

// Event listeners
document.getElementById('assignBtn').addEventListener('click', assignSelected);
document.getElementById('clearBtn').addEventListener('click', clearSelection);
document.getElementById('refreshBtn').addEventListener('click', async () => {
  showStatus('Refreshing data...', 'info');
  await Promise.all([loadManagersForAssignment(), loadEmployeesForAssignment(), loadAssignments()]);
  hideStatus();
});

// Initialize
(async function init() {
  await Promise.all([loadManagers(), loadEmployees(), loadLeads()]);
  await Promise.all([loadManagersForAssignment(), loadEmployeesForAssignment(), loadAssignments()]);
  initSearch();
})();
</script>

</body>
</html>